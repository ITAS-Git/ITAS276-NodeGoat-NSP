name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Secret Scanning with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
          
  SCA-Snyk:
    needs: [trufflehog]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build a Docker image
        run: docker build -t node-goat:latest .
      - name: Run Snyk to check Docker image for vulnerabilities
        continue-on-error: true
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: node-goat:latest
          args: --file=Dockerfile --sarif-file-output=snyk.sarif
      - name: Upload Snyk SARIF report
        uses: actions/upload-artifact@v3
        with:
          name: snyk-sca.sarif
          path: snyk.sarif
          
  SAST-Semgrep:
    needs: [trufflehog]  
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Semgrep Scan
        run: |
          docker run --rm -v "${{ github.workspace }}:/src" returntocorp/semgrep semgrep --config=p/r2c-ci --sarif --output=/src/semgrep-sast.sarif /src
          
      - name: Upload Semgrep SARIF report
        uses: actions/upload-artifact@v3
        with:
          name: semgrep-sast.sarif
          path: semgrep-sast.sarif
          
  Discord-Notification:
    needs: [ trufflehog, SCA-Snyk, SAST-Semgrep ]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Discord Notification
      uses: tsickert/discord-webhook@v5.3.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
        thread-id: "1226943702090387517"
        username: ${{github.repository}}
        avatar-url: https://cdn3.iconfinder.com/data/icons/corgi-dog-emoji/500/Angry_corgi_dog_emoticon_1-512.png
        content: |
          ${{ github.workflow }} Pipeline ${{ job.status }}
          Pipeline for ${{ github.repository }} ${{ job.status }}.
          Triggered by: ${{ github.triggering_actor }}
          Run ID: ${{ github.run_id }}
        embeds: |
          [{
            "title": "${{ github.workflow }} Pipeline ${{ job.status }}",
            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "description": "Pipeline for ${{ github.repository }} ${{ job.status }}.\nTriggered by: ${{ github.triggering_actor }}\nRun ID: ${{ github.run_id }}",
            "color": ${{ job.status == 'success' && 65280 || 16711680 }}
          }]
